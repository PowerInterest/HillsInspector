<script>
  document.addEventListener('DOMContentLoaded', () => {
    const mapEl = document.getElementById('auction-map');
    const statusEl = document.getElementById('auction-map-status');
    if (!mapEl) {
      console.error('Map element not found');
      return;
    }
    const map = L.map('auction-map', { zoomControl: true }).setView([27.95, -82.46], 10);
    const clearStatus = () => statusEl && (statusEl.textContent = '', statusEl.style.display = 'none');
    const showStatus = (msg) => statusEl && (statusEl.textContent = msg, statusEl.style.display = 'block');

    // Custom house icon for property markers
    const houseIcon = L.divIcon({
      className: 'property-marker',
      html: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32">
        <path fill="#2563eb" stroke="#1e40af" stroke-width="1" d="M12 2.1L1 12h3v9h6v-6h4v6h6v-9h3L12 2.1z"/>
        <circle cx="12" cy="22" r="3" fill="#1e40af" opacity="0.3"/>
      </svg>`,
      iconSize: [32, 32],
      iconAnchor: [16, 32],
      popupAnchor: [0, -32]
    });

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    })
      .on('tileerror', () => showStatus('Map tiles failed to load (check network to tile.openstreetmap.org).'))
      .on('load', clearStatus)
      .addTo(map);

    // Ensure map resizes correctly (details/hidden containers)
    const resizeMap = () => {
      setTimeout(() => map.invalidateSize(), 100);
    };
    resizeMap();

    const details = mapEl.closest('details');
    if (details) {
      details.addEventListener('toggle', resizeMap);
    }

    fetch('/api/map-auctions')
      .then((res) => res.json())
      .then((data) => {
        const markers = L.layerGroup().addTo(map);
        data.features.forEach((feature) => {
          const { lat, lon, address, case_number, auction_date, final_judgment_amount, url } = feature;
          if (lat == null || lon == null) {
            return;
          }
          const marker = L.marker([lat, lon], { icon: houseIcon });
          const popup = `
            <div class="map-popup">
              <div class="popup-address"><a href="${url}">${address || 'Unknown'}</a></div>
              <div class="popup-case">Case: ${case_number || 'N/A'}</div>
              <div class="popup-date">Auction: ${auction_date || 'N/A'}</div>
              <div class="popup-judgment">Judgment: ${final_judgment_amount ? '$' + Number(final_judgment_amount).toLocaleString() : 'N/A'}</div>
            </div>
          `;
          marker.bindPopup(popup);
          marker.on('click', () => {
            window.location.href = url;
          });
          marker.addTo(markers);
        });
        const bounds = markers.getBounds();
        if (bounds.isValid()) {
          map.fitBounds(bounds.pad(0.15));
        } else {
          map.setView([27.95, -82.46], 10);
          showStatus('No map points available yet.');
        }
        resizeMap();
        clearStatus();
      })
      .catch((err) => {
        console.error('Map load error:', err);
        showStatus('Map data failed to load.');
      });
  });
</script>

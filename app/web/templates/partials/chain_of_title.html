<div class="timeline-container">
    {% if chain_gaps %}
        <div class="chain-gap-box" style="margin-bottom: 12px; padding: 10px 12px; border: 1px solid #e6e9ef; border-radius: 8px; background: #f8fafc;">
            <div style="font-weight: 700; margin-bottom: 6px;">Chain Diagnostics</div>
            <ul style="margin: 0; padding-left: 18px;">
                {% for gap in chain_gaps %}
                    <li style="margin: 4px 0;">
                        <strong>{{ gap.gap_type }}</strong>
                        {% if gap.detail %}: {{ gap.detail }}{% endif %}
                        {% if gap.seq_prev is not none and gap.seq_next is not none %}
                            ({{ gap.seq_prev }} → {{ gap.seq_next }})
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}

    {% if not chain_of_title %}
        <div class="no-data">
            <p>No chain of title data is available for this property.</p>
        </div>
    {% else %}
        <ul class="timeline">
            {% for transfer in chain_of_title %}
                {% set st = (transfer.link_status or '')|upper %}
                <li class="timeline-item">
                    <div class="timeline-dot"></div>
                    <div class="timeline-content transfer-card">
                        <div class="transfer-header">
                            <div class="transfer-date">{{ transfer.acquisition_date or 'Date Unknown' }}</div>
                            <div class="transfer-type">
                                <span class="badge badge-secondary">{{ transfer.acquisition_doc_type or 'DOC' }}</span>
                                {% if st %}
                                    {% set badge_class = (
                                        'badge-danger' if st in ['BROKEN'] else
                                        'badge-warning' if st in ['INCOMPLETE','FUZZY'] else
                                        'badge-secondary' if st in ['IMPLIED','INFERRED'] else
                                        'badge-info'
                                    ) %}
                                    <span class="badge {{ badge_class }}">{{ st }}</span>
                                {% endif %}
                                {% if transfer.confidence_score is defined and transfer.confidence_score is not none %}
                                    <span class="badge badge-secondary">Score {{ "{:.2f}".format(transfer.confidence_score) }}</span>
                                {% elif transfer.link_score is defined and transfer.link_score is not none %}
                                    <span class="badge badge-secondary">Score {{ "{:.2f}".format(transfer.link_score) }}</span>
                                {% endif %}
                            </div>
                            <div class="transfer-price">
                                {% if transfer.acquisition_price %}
                                    ${{ "{:,.0f}".format(transfer.acquisition_price) }}
                                {% else %}
                                    -
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="transfer-flow">
                            <div class="transfer-party grantor">
                                <span class="party-label">Grantor (From)</span>
                                <span class="party-name">{{ transfer.acquired_from or 'Unknown' }}</span>
                            </div>
                            
                            <div class="transfer-arrow">
                                <span class="arrow-icon">➜</span>
                            </div>
                            
                            <div class="transfer-party grantee">
                                <span class="party-label">Grantee (To)</span>
                                <span class="party-name">{{ transfer.owner_name or 'Unknown' }}</span>
                            </div>
                        </div>

                        <div class="transfer-footer">
                            <span class="instrument-info">
                                Instrument: {{ transfer.acquisition_instrument or 'N/A' }}
                            </span>
                            {% if transfer.document_id %}
                                <a href="/property/{{ folio }}/doc/{{ transfer.document_id }}" target="_blank" class="btn-view-doc">
                                    View Document
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </li>
            {% endfor %}
             <li class="timeline-item timeline-start">
                <div class="timeline-dot"></div>
                <div class="timeline-content">
                    <div class="timeline-title">Chain Start</div>
                </div>
            </li>
        </ul>
    {% endif %}
</div>

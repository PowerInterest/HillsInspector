<div class="timeline-container">
    {% if not chain_of_title %}
        <div class="no-data">
            <p>No chain of title data is available for this property.</p>
        </div>
    {% else %}
        <ul class="timeline">
            {% for transfer in chain_of_title %}
                {% set is_break = false %}
                {% if not loop.first %}
                    {% set prev_transfer = chain_of_title[loop.index0 - 1] %}
                    {% if transfer.owner_name and prev_transfer.acquired_from and transfer.owner_name|lower != prev_transfer.acquired_from|lower %}
                        {% set is_break = true %}
                    {% endif %}
                {% endif %}

                {% if is_break %}
                <li class="timeline-break">
                    <div class="break-line"></div>
                    <div class="break-text">⚠️ Broken Chain: Grantee doesn't match next Grantor</div>
                </li>
                {% endif %}

                <li class="timeline-item">
                    <div class="timeline-dot"></div>
                    <div class="timeline-content transfer-card">
                        <div class="transfer-header">
                            <div class="transfer-date">{{ transfer.acquisition_date or 'Date Unknown' }}</div>
                            <div class="transfer-type">
                                <span class="badge badge-secondary">{{ transfer.acquisition_doc_type or 'DOC' }}</span>
                            </div>
                            <div class="transfer-price">
                                {% if transfer.acquisition_price %}
                                    ${{ "{:,.0f}".format(transfer.acquisition_price) }}
                                {% else %}
                                    -
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="transfer-flow">
                            <div class="transfer-party grantor">
                                <span class="party-label">Grantor (From)</span>
                                <span class="party-name">{{ transfer.acquired_from or 'Unknown' }}</span>
                            </div>
                            
                            <div class="transfer-arrow">
                                <span class="arrow-icon">➜</span>
                            </div>
                            
                            <div class="transfer-party grantee">
                                <span class="party-label">Grantee (To)</span>
                                <span class="party-name">{{ transfer.owner_name or 'Unknown' }}</span>
                            </div>
                        </div>

                        <div class="transfer-footer">
                            <span class="instrument-info">
                                Instrument: {{ transfer.acquisition_instrument or 'N/A' }}
                            </span>
                            {% if transfer.document_id %}
                                <a href="/property/{{ folio }}/doc/{{ transfer.document_id }}" target="_blank" class="btn-view-doc">
                                    View Document
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </li>
            {% endfor %}
             <li class="timeline-item timeline-start">
                <div class="timeline-dot"></div>
                <div class="timeline-content">
                    <div class="timeline-title">Chain Start</div>
                </div>
            </li>
        </ul>
    {% endif %}
</div>

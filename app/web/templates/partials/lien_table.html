{% if liens or encumbrances %}

{% set foreclosing_encs = encumbrances|selectattr('survival_status', 'equalto', 'FORECLOSING')|list %}
{% if foreclosing_encs %}
    {% set fc = foreclosing_encs[0] %}
    <div class="lien-summary">
        <strong>Foreclosing Lien:</strong>
        {{ fc.encumbrance_type or 'Unknown' }}{% if fc.creditor %} â€” {{ fc.creditor }}{% endif %}
        {% if fc.instrument %} (Inst {{ fc.instrument }}){% elif fc.book and fc.page %} (Bk/Pg {{ fc.book }}/{{ fc.page }}){% endif %}
        {% if fc.is_inferred %}
            <span style="margin-left: 0.5rem; color: var(--color-text-muted);">(Inferred)</span>
        {% endif %}
        {% if auction and auction.plaintiff %}
            <span style="margin-left: 0.5rem; color: var(--color-text-muted);">(Plaintiff: {{ auction.plaintiff }})</span>
        {% endif %}
</div>
{% endif %}

<table class="lien-table">
    <thead>
        <tr>
            <th>Recording Date</th>
            <th>Type</th>
            <th>Amount</th>
            <th>Holder</th>
            <th>Survives?</th>
        </tr>
    </thead>
    <tbody>
        {% if not encumbrances %}
        {% for lien in liens %}
        <tr class="{% if lien.is_surviving %}surviving{% else %}wiped{% endif %}">
            <td>{{ lien.recording_date|format_date if lien.recording_date else '-' }}</td>
            <td>{{ lien.document_type or '-' }}</td>
            <td class="money-cell">{{ "${:,.0f}".format(lien.amount) if lien.amount else '-' }}</td>
            <td>{{ lien.grantee or lien.grantor or '-' }}</td>
            <td>
                {% if lien.is_surviving == True %}
                <span class="survival-badge survives">SURVIVES</span>
                {% elif lien.is_surviving == False %}
                <span class="survival-badge wiped">WIPED</span>
                {% else %}
                <span class="survival-badge unknown">UNKNOWN</span>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
        {% endif %}

        {% for enc in encumbrances %}
        {% set st = (enc.survival_status or '')|upper %}
        <tr class="{% if st == 'FORECLOSING' %}foreclosing{% elif st == 'SURVIVED' %}surviving{% elif st in ['EXTINGUISHED','HISTORICAL','EXPIRED'] %}wiped{% endif %}">
            <td>{{ enc.recording_date|format_date if enc.recording_date else '-' }}</td>
            <td>{{ enc.encumbrance_type or '-' }}</td>
            <td class="money-cell">
                {{ "${:,.0f}".format(enc.amount) if enc.amount else '-' }}
                {% if enc.amount_confidence and enc.amount_confidence != 'HIGH' %}
                <span class="confidence-badge {{ enc.amount_confidence|lower }}">{{ enc.amount_confidence }}</span>
                {% endif %}
            </td>
            <td>
                {{ enc.creditor or '-' }}
                {% if enc.is_joined %}
                <span class="joined-badge" title="Named as Defendant in Foreclosure">JOINED</span>
                {% endif %}
            </td>
            <td>
                {% if st == 'FORECLOSING' %}
                <span class="survival-badge foreclosing">FORECLOSING{% if enc.is_inferred %} (INFERRED){% endif %}</span>
                {% elif st == 'SURVIVED' %}
                <span class="survival-badge survives">SURVIVES</span>
                {% elif st == 'EXTINGUISHED' %}
                <span class="survival-badge wiped">WIPED</span>
                {% elif st == 'HISTORICAL' %}
                <span class="survival-badge wiped">HISTORICAL</span>
                {% elif st == 'EXPIRED' %}
                <span class="survival-badge wiped">EXPIRED</span>
                {% elif st == 'SATISFIED' %}
                <span class="survival-badge satisfied">SATISFIED</span>
                {% elif not enc.survival_status %}
                <span class="survival-badge unknown">PENDING</span>
                {% else %}
                <span class="survival-badge unknown">{{ st }}</span>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% if liens and not encumbrances %}
<div class="lien-summary">
    <strong>Total Liens Found:</strong> {{ liens|length }}
    {% set surviving_count = liens|selectattr('is_surviving', 'equalto', True)|list|length %}
    {% if surviving_count > 0 %}
    | <span class="warning">{{ surviving_count }} surviving</span>
    {% endif %}
</div>
{% endif %}

{% else %}
<p class="no-data">No liens found for this property.</p>
<p class="no-data-hint">This could mean:
    <ul>
        <li>Lien research hasn't been run yet</li>
        <li>No liens were found in Official Records</li>
        <li>The property has a clean title</li>
    </ul>
</p>
{% endif %}

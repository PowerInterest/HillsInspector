{% extends "base.html" %}

{% block title %}{{ auction.property_address or 'Property' }} - HillsInspector{% endblock %}

{% block content %}
<div class="property-detail">
    <!-- Breadcrumb -->
    <nav class="breadcrumb">
        <a href="/">Dashboard</a> &raquo;
        <span>{{ auction.property_address or auction.folio }}</span>
    </nav>

    <!-- Limited Analysis Banner (Mobile Homes / No Parcel ID) -->
    {% if auction.has_valid_parcel_id == false %}
    <div class="alert alert-warning" style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 15px 20px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 24px;">⚠️</span>
        <div>
            <strong>Limited Analysis Available</strong>
            <p style="margin: 5px 0 0 0; color: #856404;">This property (likely a mobile home lot or unresolved parcel) does not have a standard county parcel ID. Only Final Judgment data is available. HCPA, title chain, liens, and market analysis cannot be performed.</p>
        </div>
    </div>
    {% endif %}

    <!-- Header -->
    <div class="property-header">
        <div class="property-title">
            <h1>{{ auction.property_address or 'Address Unknown' }}</h1>
            <div class="property-meta">
                <span class="folio">Folio: {{ property.folio }}</span>
                <span class="badge badge-{{ auction.auction_type|lower }}">
                    {{ auction.auction_type or 'UNKNOWN' }}
                </span>
                {% if auction.is_toxic_title %}
                <span class="flag flag-danger">TOXIC TITLE</span>
                {% endif %}
            </div>
        </div>
        {% if auction.auction_date %}
        <div class="auction-date-box">
            <div class="auction-date-label">Auction Date</div>
            <div class="auction-date-value">{{ auction.auction_date.strftime('%B %d, %Y') }}</div>
        </div>
        {% endif %}
        <div class="property-actions" style="margin-left: 20px;">
            <a href="/property/{{ auction.case_number or property.folio }}/title-report" target="_blank" class="btn btn-primary" style="background: #3498db; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; font-weight: bold;">
                Generate Title Report
            </a>
        </div>
    </div>

    <!-- Tabs (full-width) -->
    <div class="tabs-container property-tabs">
        <div class="tabs">
            <button class="tab-link active" onclick="openTab(event, 'basic')">Basic</button>
            <button class="tab-link" onclick="openTab(event, 'judgment')">Judgment</button>
            <button class="tab-link" onclick="openTab(event, 'chain')">Chain of Title</button>
            <button class="tab-link" onclick="openTab(event, 'liens')">Liens & Encumbrances</button>
            <button class="tab-link" onclick="openTab(event, 'permits')">Permits & NOCs</button>
            <button class="tab-link" onclick="openTab(event, 'tax')">Tax</button>
            <button class="tab-link" onclick="openTab(event, 'documents')">Documents</button>
        </div>

        <!-- Basic Tab (rendered server-side) -->
        <div id="basic" class="tab-content active">
            <div class="property-detail-grid">
                <div class="property-column">
                    {% set photos = (market.photos if market and market.photos else []) %}
                    <section class="card property-media">
                        <h2>Photos</h2>
                        {% if photos %}
                        <div class="media-hero">
                            <img src="{{ photos[0] }}" loading="lazy" alt="Property photo">
                        </div>
                        <div class="media-thumbs">
                            {% for url in photos[1:12] %}
                            <img src="{{ url }}" loading="lazy" alt="Property thumbnail">
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="card-image-placeholder">
                            <span class="placeholder-text">No HomeHarvest Photo</span>
                        </div>
                        {% endif %}
                    </section>

                    {% include "partials/market_module.html" %}

                    <section class="card">
                        <h2>Property Overview</h2>
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">Owner</span>
                                <span class="info-value">{{ parcel.owner_name or auction.owner_name or 'Unknown' }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Beds</span>
                                <span class="info-value">{{ parcel.beds|int if parcel.beds else '-' }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Baths</span>
                                <span class="info-value">{{ parcel.baths if parcel.baths else '-' }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Sq Ft</span>
                                <span class="info-value">{{ "{:,.0f}".format(parcel.heated_area) if parcel.heated_area else '-' }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Year Built</span>
                                <span class="info-value">{{ parcel.year_built|int if parcel.year_built else '-' }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Land Use</span>
                                <span class="info-value">{{ parcel.land_use_desc or parcel.land_use or '-' }}</span>
                            </div>
                            {% if enrichments and enrichments.flood_zone %}
                            <div class="info-item">
                                <span class="info-label">Flood</span>
                                <span class="info-value">
                                    {{ enrichments.flood_zone }}{% if enrichments.flood_risk %} ({{ enrichments.flood_risk }}){% endif %}
                                </span>
                            </div>
                            {% endif %}
                        </div>
                    </section>
                </div>

                <div class="property-column">
                    <section class="card equity-card">
                        <h2>Net Equity Analysis</h2>
                        <div class="equity-breakdown">
                            <div class="equity-line">
                                <span>Market Value (Est.)</span>
                                <span class="money positive">{{ "${:,.0f}".format(market_value) }}</span>
                            </div>
                            <div class="equity-line subtract">
                                <span>Final Judgment</span>
                                <span class="money">- {{ "${:,.0f}".format(auction.final_judgment_amount) if auction.final_judgment_amount else '$0' }}</span>
                            </div>
                            <div class="equity-line subtract">
                                <span>Est. Surviving Liens</span>
                                <span class="money">- {{ "${:,.0f}".format(auction.est_surviving_debt) if auction.est_surviving_debt else '$0' }}</span>
                            </div>
                            <div class="equity-line total">
                                <span>NET EQUITY</span>
                                <span class="money {% if net_equity > 0 %}positive{% elif net_equity < 0 %}negative{% endif %}">
                                    {{ "${:,.0f}".format(net_equity) }}
                                </span>
                            </div>
                        </div>
                        {% if net_equity < 0 %}
                        <div class="equity-warning">
                            Warning: Negative equity - potential loss
                        </div>
                        {% endif %}
                    </section>

                    <section class="card">
                        <h2>Valuation</h2>
                        <div class="valuation-grid">
                            <div class="valuation-item">
                                <span class="valuation-label">HCPA Assessed</span>
                                <span class="valuation-value">{{ "${:,.0f}".format(parcel.assessed_value) if parcel and parcel.assessed_value else '-' }}</span>
                            </div>
                            <div class="valuation-item">
                                <span class="valuation-label">HCPA Market</span>
                                <span class="valuation-value">{{ "${:,.0f}".format(parcel.market_value) if parcel and parcel.market_value else '-' }}</span>
                            </div>
                            <div class="valuation-item">
                                <span class="valuation-label">Auction Assessed</span>
                                <span class="valuation-value">{{ "${:,.0f}".format(auction.assessed_value) if auction.assessed_value else '-' }}</span>
                            </div>
                            {% if parcel and parcel.last_sale_price %}
                            <div class="valuation-item">
                                <span class="valuation-label">Last Sale</span>
                                <span class="valuation-value">{{ "${:,.0f}".format(parcel.last_sale_price) }} ({{ parcel.last_sale_date }})</span>
                            </div>
                            {% endif %}
                        </div>
                    </section>

                    <section class="card">
                        <h2>Auction Information</h2>
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">Case Number</span>
                                <span class="info-value">
                                    <a href="https://hover.hillsclerk.com" target="_blank">{{ auction.case_number }}</a>
                                </span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Auction Type</span>
                                <span class="info-value">{{ auction.auction_type }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Final Judgment</span>
                                <span class="info-value money">{{ "${:,.2f}".format(auction.final_judgment_amount) if auction.final_judgment_amount else 'Not Available' }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Opening Bid</span>
                                <span class="info-value money">{{ "${:,.2f}".format(auction.opening_bid) if auction.opening_bid else 'Not Published Yet' }}</span>
                            </div>
                            {% if auction.plaintiff_max_bid %}
                            <div class="info-item">
                                <span class="info-label">Plaintiff Max Bid</span>
                                <span class="info-value money">{{ auction.plaintiff_max_bid }}</span>
                            </div>
                            {% endif %}
                            <div class="info-item">
                                <span class="info-label">Status</span>
                                <span class="info-value">{{ auction.status or 'PENDING' }}</span>
                            </div>
                            {% if auction.plaintiff %}
                            <div class="info-item">
                                <span class="info-label">Plaintiff (Foreclosing)</span>
                                <span class="info-value">{{ auction.plaintiff }}</span>
                            </div>
                            {% endif %}
                            {% if auction.foreclosure_type %}
                            <div class="info-item">
                                <span class="info-label">Foreclosure Type</span>
                                <span class="info-value">{{ auction.foreclosure_type }}</span>
                            </div>
                            {% endif %}
                            {% if auction.lis_pendens_date %}
                            <div class="info-item">
                                <span class="info-label">Lis Pendens Date</span>
                                <span class="info-value">{{ auction.lis_pendens_date }}</span>
                            </div>
                            {% endif %}
                            {% if auction.extracted_judgment_data and auction.extracted_judgment_data.get('foreclosed_mortgage') %}
                                {% set fm = auction.extracted_judgment_data.get('foreclosed_mortgage') %}
                                {% if fm and (fm.get('instrument_number') or fm.get('recording_book') or fm.get('recording_page')) %}
                                <div class="info-item">
                                    <span class="info-label">Foreclosed Mortgage Ref</span>
                                    <span class="info-value">
                                        {% if fm.get('instrument_number') %}Inst {{ fm.get('instrument_number') }}{% endif %}
                                        {% if fm.get('recording_book') and fm.get('recording_page') %}
                                            {% if fm.get('instrument_number') %} | {% endif %}
                                            Bk/Pg {{ fm.get('recording_book') }}/{{ fm.get('recording_page') }}
                                        {% endif %}
                                    </span>
                                </div>
                                {% endif %}
                            {% endif %}
                        </div>
                    </section>

                </div>
            </div>
            <!-- Sales History - Full Width -->
            <section class="card" style="margin-top: 1.5rem;">
                <h2>Sales History</h2>
                <div id="sales-history-section"
                     hx-get="/property/{{ property.folio }}/sales"
                     hx-trigger="load"
                     hx-swap="innerHTML">
                    <div class="htmx-loading">Loading sales history...</div>
                </div>
            </section>
        </div>

        <!-- Judgment Tab -->
        <div id="judgment" class="tab-content"
             hx-get="/property/{{ property.folio }}/judgment"
             hx-trigger="load"
             hx-swap="innerHTML"
             style="display:none;">
            <div class="htmx-loading">Loading judgment data...</div>
        </div>

        <!-- Permits Tab -->
        <div id="permits" class="tab-content"
             hx-get="/property/{{ property.folio }}/permits"
             hx-trigger="load"
             hx-swap="innerHTML"
             style="display:none;">
            <div class="htmx-loading">Loading permits...</div>
        </div>

        <!-- Liens Tab -->
        <div id="liens" class="tab-content"
             hx-get="/property/{{ property.folio }}/liens"
             hx-trigger="load"
             hx-swap="innerHTML"
             style="display:none;">
            <div class="htmx-loading">Loading liens...</div>
        </div>

        <!-- Tax Tab -->
        <div id="tax" class="tab-content"
             hx-get="/property/{{ property.folio }}/tax"
             hx-trigger="load"
             hx-swap="innerHTML"
             style="display:none;">
            <div class="htmx-loading">Loading tax...</div>
        </div>

        <!-- Documents Tab -->
        <div id="documents" class="tab-content"
             hx-get="/property/{{ property.folio }}/documents"
             hx-trigger="load"
             hx-swap="innerHTML"
             style="display:none;">
            <div class="htmx-loading">Loading documents...</div>
        </div>

        <!-- Chain Tab -->
        <div id="chain" class="tab-content"
             hx-get="/property/{{ property.folio }}/chain"
             hx-trigger="load"
             hx-swap="innerHTML"
             style="display:none;">
            <div class="htmx-loading">Loading chain of title...</div>
        </div>
    </div>

    <!-- OCR Content (if available) -->
    {% if auction.final_judgment_content %}
    <section class="card ocr-section">
        <h2>Final Judgment OCR Text</h2>
        <details>
            <summary>Show extracted text</summary>
            <pre class="ocr-text">{{ auction.final_judgment_content }}</pre>
        </details>
    </section>
    {% endif %}
    
    <!-- Data Sources -->
    {% if property.sources %}
    <section class="card sources-section">
        <h2>Data Sources</h2>
        <div class="table-container">
            <table class="auction-table">
                <thead>
                    <tr>
                        <th>Source</th>
                        <th>URL</th>
                        <th>Description</th>
                        <th>Captured At</th>
                    </tr>
                </thead>
                <tbody>
                    {% for source in property.sources %}
                    <tr class="auction-row">
                        <td>{{ source.source_name }}</td>
                        <td>
                            <a href="{{ source.url }}" target="_blank" rel="noopener noreferrer">
                                {{ source.url[:60] }}{% if source.url|length > 60 %}...{% endif %}
                            </a>
                        </td>
                        <td>{{ source.description }}</td>
                        <td>{{ source.created_at }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>
    {% endif %}
</div>
{% endblock %}
